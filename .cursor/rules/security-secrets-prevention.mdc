---
description: Prevent secrets, API keys, and credentials from being committed to git
alwaysApply: true
---

# Security: Secrets Prevention

**Critical Rule:** NEVER allow secrets, API keys, tokens, or credentials to be committed to git.

## üö® Before ANY Git Commit

**MANDATORY checks before committing:**

1. **Scan staged files for secrets:**
   ```bash
   git diff --cached | grep -E "(api[_-]?key|secret|password|token|credential)"
   ```

2. **Check for actual secret values:**
   - Bot tokens (format: `XXXXXXXXXX:XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX`)
   - API keys (format: `AIza...`, `sk-...`, `AAE...`)
   - Service account filenames (format: `project-name-abc123def456.json`)

3. **Verify no backup files:**
   ```bash
   git status --short | grep -E "\.(env|bak|backup|key|pem|credentials)"
   ```

## ‚ùå NEVER Commit These Patterns

### Environment Files
```
.env
.env.*
.env.bak
.env.backup
.env.local
*.env.bak
```

### Credentials
```
*.json (service accounts)
.credentials/
*.key
*.pem
*.p12
*.secret
credentials.json
serviceAccount.json
```

### Backups Created by Tools
```
.env.bak       # Created by sed
.env.backup    # Created by cp
*.orig         # Created by git merge
*.swp          # Created by vim
```

## ‚úÖ Safe Alternatives

### In Code - Use Environment Variables
```python
# ‚ùå NEVER
bot_token = "8197561499:AAEhBUhr..."

# ‚úÖ ALWAYS
bot_token = os.getenv("TELEGRAM_BOT_TOKEN")
```

### In Documentation - Use Placeholders
```markdown
‚ùå NEVER:
curl https://api.telegram.org/bot8197561499:AAE.../getMe

‚úÖ ALWAYS:
curl https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/getMe
```

### In Examples - Use Fake Values
```bash
‚ùå NEVER:
TELEGRAM_BOT_TOKEN=8197561499:AAEhBUhr...

‚úÖ ALWAYS:
TELEGRAM_BOT_TOKEN=your_bot_token_here
```

## üõ°Ô∏è Required .gitignore Patterns

Ensure these patterns are in `.gitignore`:

```gitignore
# Environment Variables
.env
.env.*
.env.local
.env.backup
.env.bak
*.env.bak

# Service Accounts
.credentials/
*.json (with exceptions for package.json, etc.)

# Keys & Certificates
*.pem
*.key
*.p12
*.pfx
*.secret
secrets/

# Backups
*.bak
*.backup
*.orig
```

## üîç When Editing Documentation

**Check EVERY curl command, code example, and configuration snippet:**

1. Search for actual bot tokens: `grep -r ":[A-Za-z0-9_-]{35}" *.md`
2. Search for API keys: `grep -r "AIza[A-Za-z0-9_-]{35}" *.md`
3. Replace with environment variables or placeholders

## üöë If Secrets Are Detected

**STOP immediately and:**

1. **DO NOT commit** - unstage the files
2. **Scrub the secrets** - replace with placeholders
3. **Delete backup files** - remove .env.bak, etc.
4. **Check git history** - ensure never committed: `git log --all -p | grep "SECRET_PATTERN"`
5. **If already committed** - notify user to rotate secrets immediately

## üìã Pre-Commit Checklist

Before EVERY commit, verify:

- [ ] Run `git status` - no .env* files listed
- [ ] Run `git diff --cached` - no secrets visible
- [ ] Check documentation - no hardcoded tokens
- [ ] Verify .gitignore - patterns up to date
- [ ] Scan for patterns - no bot tokens, API keys
- [ ] Review examples - only placeholders used

## üéØ Detection Patterns

Alert if you see these in staged files:

**Bot Tokens:**
- `\d{10}:[A-Za-z0-9_-]{35}` (Telegram format)
- `xoxb-[0-9]{10,13}-[0-9]{10,13}-[A-Za-z0-9]{24}` (Slack format)

**API Keys:**
- `AIza[A-Za-z0-9_-]{35}` (Google API)
- `sk-[A-Za-z0-9]{20,}` (OpenAI, Stripe)
- `AKIA[A-Z0-9]{16}` (AWS)

**Service Account Filenames:**
- `*-[a-f0-9]{12}\.json`
- Contains "serviceaccount", "credentials", "key"

## üìö Reference: Today's Security Incident

**What happened (Feb 7, 2026):**
- `.env.bak` created by `sed` during deployment
- Bot token appeared in TEST_PRODUCTION_NOW.md
- Files staged for commit (caught before push!)

**Why it was dangerous:**
- Public GitHub repo
- Full bot access with token
- Nearly pushed to remote

**How we prevented it:**
- Detected in time (never pushed)
- Scrubbed all instances
- Enhanced .gitignore
- Created this rule

**Lesson:** ALWAYS check staged files before committing. One `git diff --cached` prevents exposure.
